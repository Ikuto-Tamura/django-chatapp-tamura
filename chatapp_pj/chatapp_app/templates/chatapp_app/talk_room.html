{% extends 'chatapp_app/base.html' %}
{% load static %}
{% block content %}

<h2 class="chat-title">
    <a href="{% url 'home' %}"><img src="{% static 'img/back_button.png' %}" alt="back button" class="back-button"></a>
    {{ other_user.username }}</h2>

<div class="chat-box" id="chat-box">
    {% for message in messages %}
        {% if message.sender == request.user %}
            <div class="message my-message">
                <img src="{{ message.sender.user_icon.url }}" class="profile-img">
                <div class="message-content">
                    {{ message.chat }}
                    <span class="timestamp">{{ message.created_at}}</span>
                </div>
            </div>
        {% else %}
            <div class="message other-message">
                <img src="{{ message.sender.user_icon.url }}" class="profile-img">
                <div class="message-content">
                    {{ message.chat }}
                    <span class="timestamp">{{ message.created_at}}</span>
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>

<form method="post" class="message-form">
    {% csrf_token %}
    <div class="input-wrapper">
        <input type="text" name="message" placeholder="メッセージを入力" required>
        <button type="submit">
            <span class="material-icons">送信</span>
        </button>
    </div>
</form>

<style>
    :root {
        --md-primary: #6200ea;
        --md-secondary: #03dac6;
        --md-surface: #f5f5f5;
        --md-on-primary: #ffffff;
        --md-on-secondary: #000000;
        --md-outline: #c7c7c7;
        --md-shadow: rgba(0, 0, 0, 0.2);
        --md-bg-my-message: #e8def8;
        --md-bg-other-message: #e0e0e0;
    }

    body {
        font-family: 'Roboto', sans-serif;
        background-color: var(--md-surface);
        margin: 0;
        padding: 0;
    }

    .chat-title {
        font-size: 1.5rem;
        color: var(--md-primary);
        padding: 0 16px;
    }

    .back-button{
        margin-left:25px;
        width:25px;
        height: inherit;
    }

    .chat-box {
        width: 80%;
        max-width: 1000px;
        height: 500px;
        overflow-y: auto;
        padding: 0;
        background-color: var(--md-surface);
        border: 1px solid var(--md-outline);
        border-radius: 12px;
        box-shadow: 0 4px 8px var(--md-shadow);
        margin-bottom: 16px;
        margin-left: 20px;
        display: flex;
        flex-direction: column; /* 下から上にスクロール */
    }

    .message {
        display: flex;
        align-items: center;
        margin: 6px 0;
        margin-left: 10px;
    }

    .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
    }

    .my-message {
        background-color: var(--md-bg-my-message);
        padding: 12px;
        width: calc(100% - 50px);
        border-top-right-radius: 0;
        border-radius: 8px;
    }

    .other-message {
        background-color: var(--md-bg-other-message);
        padding: 12px;
        width: calc(100% - 50px);
        border-top-left-radius: 0;
        border-radius: 8px;
    }

    .message-content {
        font-size: 16px;
        line-height: 1.5;
        color: #000;
        word-wrap: break-word;
    }

    .timestamp {
        font-size: 12px;
        color: var(--md-outline);
        margin-top: 4px;
        display: block;
    }

    .message-form {
        padding: 0;
        width: 80%;
        max-width: 1000px;
        margin-left: 20px;
    }

    .input-wrapper {
        display: flex;
        align-items: center;
        background-color: var(--md-surface);
        border: 1px solid var(--md-outline);
        border-radius: 24px;
        padding: 8px;
        box-shadow: 0 2px 4px var(--md-shadow);
    }

    .message-form input {
        flex: 1;
        border: none;
        outline: none;
        padding: 8px;
        font-size: 16px;
        background-color: transparent;
        color: inherit;
    }

    .message-form button {
        background-color: var(--md-primary);
        color: var(--md-on-primary);
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px var(--md-shadow);
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .message-form button:hover {
        background-color: #3700b3;
    }

    .material-icons {
        font-size: 24px;
    }
    
</style>

<script>
    window.onload = function() {
        var chatBox = document.querySelector('.chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    // 新しいメッセージが追加されるたびに最下層にスクロール
    var chatBox = document.querySelector('.chat-box');
    var observer = new MutationObserver(function() {
        chatBox.scrollTop = chatBox.scrollHeight;
    });
    observer.observe(chatBox, { childList: true });
</script>


{% endblock %}
